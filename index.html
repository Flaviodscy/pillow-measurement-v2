<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dream Pillow Finder - Camera Measurements</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background: #0a0a0a;
            color: #fff;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: radial-gradient(circle at 20% 50%, rgba(120,119,198,0.3) 0%, transparent 50%),
                        radial-gradient(circle at 80% 20%, rgba(255,119,198,0.3) 0%, transparent 50%);
            animation: flow 20s ease-in-out infinite;
            z-index: -1;
        }
        
        @keyframes flow {
            0%, 100% { transform: scale(1) rotate(0deg); }
            50% { transform: scale(1.1) rotate(180deg); }
        }
        
        .container {
            max-width: 600px;
            margin: 30px auto;
            padding: 50px 40px;
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        h1 {
            text-align: center;
            font-size: 36px;
            margin-bottom: 20px;
            background: linear-gradient(45deg, #fff, #a855f7, #06b6d4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .subtitle { 
            text-align: center; 
            opacity: 0.8; 
            margin-bottom: 40px; 
            font-size: 16px;
            line-height: 1.5;
        }
        
        .progress-bar {
            height: 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            margin-bottom: 40px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #06b6d4, #a855f7);
            transition: width 0.5s ease;
            width: 0%;
        }
        
        .measurement-section {
            background: rgba(168,85,247,0.15);
            border: 2px solid rgba(168,85,247,0.4);
            border-radius: 20px;
            padding: 40px 30px;
            margin-bottom: 40px;
            text-align: center;
        }
        
        .measurement-section h3 {
            font-size: 24px;
            margin-bottom: 20px;
            color: #fff;
        }
        
        .measurement-section p {
            margin-bottom: 30px;
            line-height: 1.6;
        }
        
        .measurement-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 20px;
            margin: 30px 0;
            max-width: 100%;
        }
        
        .measurement-card {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 15px;
            padding: 20px 15px;
            text-align: center;
            min-width: 0;
        }
        
        .measurement-value {
            font-size: 28px;
            font-weight: bold;
            color: #a855f7;
            word-break: break-word;
            margin-bottom: 8px;
        }
        
        .measurement-label {
            font-size: 12px;
            opacity: 0.8;
            margin-top: 5px;
        }
        
        .btn {
            padding: 18px 32px;
            border: none;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
            margin: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(45deg, #a855f7, #06b6d4);
            color: white;
        }
        
        .btn-secondary {
            background: rgba(255,255,255,0.1);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
        }
        
        /* CAMERA SYSTEM - PRIORITY */
        .camera-container {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.95);
            backdrop-filter: blur(40px);
            display: none;
            z-index: 2000;
        }
        
        .camera-container.active { display: block; }
        
        .camera-view-wrapper {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        
        #camera-feed {
            width: 100%;
            height: 100%;
            object-fit: contain;
            transform: scaleX(-1) scale(0.8);
            background: #000;
        }
        
        #captured-image {
            width: 100%;
            height: 100%;
            object-fit: contain;
            transform: scaleX(-1) scale(0.8);
            background: #000;
            display: none;
        }
        
        .distance-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 300px;
            height: 300px;
            pointer-events: none;
            z-index: 4;
        }
        
        .distance-circle {
            width: 100%;
            height: 100%;
            border: 4px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            transition: all 0.4s ease;
            backdrop-filter: blur(10px);
        }
        
        .distance-circle.too-close {
            border-color: #ef4444;
            animation: pulse-warning 1s ease-in-out infinite;
            box-shadow: 0 0 40px rgba(239,68,68,0.5);
        }
        
        .distance-circle.too-far {
            border-color: #f59e0b;
            animation: pulse-warning 1s ease-in-out infinite;
            box-shadow: 0 0 40px rgba(245,158,11,0.5);
        }
        
        .distance-circle.perfect {
            border-color: #10b981;
            box-shadow: 0 0 60px rgba(16,185,129,0.6);
            animation: pulse-success 2s ease-in-out infinite;
        }
        
        @keyframes pulse-warning {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }
        
        @keyframes pulse-success {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }
        
        .distance-feedback {
            position: absolute;
            top: 20%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(30px);
            color: white;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            z-index: 6;
            display: none;
        }
        
        .distance-feedback.show { display: block; }
        .distance-feedback.too-close { background: rgba(239,68,68,0.9); }
        .distance-feedback.too-far { background: rgba(245,158,11,0.9); }
        .distance-feedback.perfect { background: rgba(16,185,129,0.9); }
        
        .face-guide {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 220px;
            height: 290px;
            pointer-events: none;
            z-index: 5;
        }
        
        .face-outline {
            width: 100%;
            height: 100%;
            border: 3px dashed rgba(255,255,255,0.8);
            border-radius: 120px 120px 150px 150px / 160px 160px 180px 180px;
            animation: pulse 2s ease-in-out infinite;
            transition: all 0.4s ease;
        }
        
        .face-outline.aligned {
            border-color: #10b981;
            border-style: solid;
            box-shadow: 0 0 40px rgba(16,185,129,0.6);
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.02); opacity: 1; }
        }
        
        .camera-header {
            position: absolute;
            top: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(40px);
            padding: 20px 40px;
            border-radius: 25px;
            text-align: center;
            z-index: 10;
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .camera-header h3 {
            color: #fff;
            margin: 0;
            font-size: 18px;
        }
        
        .camera-header p {
            color: rgba(255,255,255,0.8);
            margin: 5px 0 0 0;
            font-size: 14px;
        }
        
        .camera-controls {
            position: absolute;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 20px;
            z-index: 20;
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(40px);
            padding: 15px;
            border-radius: 25px;
        }
        
        .camera-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            background: rgba(255,255,255,0.2);
            color: #fff;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .camera-btn.primary {
            background: linear-gradient(45deg, #a855f7, #06b6d4);
            width: 70px;
            height: 70px;
        }
        
        .camera-btn.capture {
            background: linear-gradient(45deg, #10b981, #059669);
            width: 70px;
            height: 70px;
        }
        
        .camera-btn:hover {
            transform: scale(1.1);
        }
        
        .close-camera {
            position: absolute;
            top: 30px;
            right: 30px;
            width: 50px;
            height: 50px;
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 50%;
            color: #fff;
            font-size: 20px;
            cursor: pointer;
            z-index: 25;
        }
        
        .measurement-point {
            position: absolute;
            width: 40px;
            height: 40px;
            transform: translate(-50%, -50%);
            cursor: move;
            z-index: 15;
            pointer-events: auto;
            touch-action: none;
        }
        
        .point-inner {
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.9);
            border: 3px solid #a855f7;
            border-radius: 50%;
            box-shadow: 0 4px 12px rgba(168,85,247,0.4);
            transition: all 0.3s ease;
        }
        
        .measurement-point.active .point-inner {
            transform: scale(1.2);
        }
        
        .measurement-line {
            position: absolute;
            background: linear-gradient(90deg, #fbbf24, #f59e0b);
            height: 3px;
            transform-origin: left center;
            z-index: 14;
            pointer-events: none;
            border-radius: 2px;
        }
        
        .measurement-label {
            position: absolute;
            background: rgba(255,255,255,0.95);
            color: #1f2937;
            padding: 8px 16px;
            border-radius: 15px;
            font-size: 14px;
            font-weight: 700;
            transform: translate(-50%, -50%);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 20;
            pointer-events: none;
        }
        
        .option {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 15px;
            padding: 25px 20px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .option:hover {
            background: rgba(255,255,255,0.15);
            transform: translateY(-2px);
        }
        
        .option.selected {
            background: rgba(168,85,247,0.3);
            border-color: #a855f7;
        }
        
        .option strong {
            display: block;
            font-size: 18px;
            margin-bottom: 8px;
        }
        
        .option small {
            opacity: 0.7;
            font-size: 14px;
            line-height: 1.4;
        }
        
        .navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 40px;
            gap: 20px;
        }
        
        .results {
            display: none;
        }
        
        .result-card {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 20px;
            padding: 35px 30px;
            margin-bottom: 25px;
        }
        
        .result-card h3 {
            margin-bottom: 15px;
            line-height: 1.3;
        }
        
        .result-card p {
            margin-bottom: 25px;
            line-height: 1.6;
        }
        
        .share-save-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin: 30px 0;
        }
        
        @media (max-width: 600px) {
            .container { margin: 10px; padding: 20px; }
            h1 { font-size: 28px; }
            .measurement-grid { grid-template-columns: 1fr; }
            .face-guide { width: 180px; height: 240px; }
            .distance-indicator { width: 250px; height: 250px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🌙 Dream Pillow Finder</h1>
        <p class="subtitle">Camera-based measurements for perfect sleep</p>
        
        <div class="progress-bar">
            <div class="progress-fill" id="progress"></div>
        </div>
        
        <div id="measurements" class="measurement-section">
            <h3>📸 Required: Camera Measurements</h3>
            <p style="opacity: 0.9; margin-bottom: 20px;">Accurate measurements ensure the perfect pillow fit</p>
            
            <div id="current-measurements" style="display: none;">
                <h4 style="margin-bottom: 15px;">✓ Your Measurements:</h4>
                <div class="measurement-grid">
                    <div class="measurement-card">
                        <div class="measurement-value" id="neck-display">-</div>
                        <div class="measurement-label">Neck Width (cm)</div>
                    </div>
                    <div class="measurement-card">
                        <div class="measurement-value" id="shoulder-display" style="color: #06b6d4;">-</div>
                        <div class="measurement-label">Shoulder Width (cm)</div>
                    </div>
                    <div class="measurement-card">
                        <div class="measurement-value" id="length-display" style="color: #ec4899;">-</div>
                        <div class="measurement-label">Neck-Shoulder (cm)</div>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="continueToQuiz()" style="margin-top: 15px;">Continue to Questions</button>
            </div>
            
            <div id="camera-prompt">
                <button class="btn btn-primary" onclick="startCamera()" style="font-size: 18px; padding: 20px 40px;">
                    📸 Start Camera Measurement
                </button>
                <p style="font-size: 14px; opacity: 0.7; margin-top: 15px;">
                    We'll guide you through measuring your neck and shoulders for the perfect pillow fit
                </p>
            </div>
        </div>
        
        <div id="quiz" style="display: none;"></div>
        <div id="results" class="results"></div>
        
        <div class="navigation" id="nav" style="display: none;">
            <button class="btn btn-secondary" id="prev" onclick="prevQ()">Previous</button>
            <button class="btn btn-primary" id="next" onclick="nextQ()" disabled>Next</button>
        </div>
    </div>
    
    <!-- CAMERA SYSTEM -->
    <div class="camera-container" id="camera">
        <div class="camera-view-wrapper">
            <video id="camera-feed" autoplay playsinline muted></video>
            <canvas id="captured-image"></canvas>
        </div>
        
        <div class="distance-indicator">
            <div class="distance-circle" id="distance-circle"></div>
        </div>
        
        <div class="distance-feedback" id="distance-feedback"></div>
        
        <div class="face-guide">
            <div class="face-outline" id="face-outline"></div>
        </div>
        
        <button class="close-camera" onclick="closeCamera()">×</button>
        
        <div class="camera-header">
            <h3 id="measurement-step">Position Your Face</h3>
            <p id="measurement-instruction">Align your face within the guide</p>
        </div>
        
        <div id="measurement-visuals" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 8;"></div>
        
        <div class="camera-controls">
            <button class="camera-btn capture" id="capture-btn" onclick="captureImage()" style="display: none;">📷</button>
            <button class="camera-btn primary" id="add-point-btn" onclick="addPoint()" style="display: none;">+</button>
            <button class="camera-btn" id="next-step-btn" onclick="nextStep()" style="display: none;">→</button>
            <button class="camera-btn" id="retake-btn" onclick="retakePhoto()" style="display: none;">🔄</button>
            <button class="camera-btn" onclick="clearPoints()">×</button>
        </div>
    </div>
    
    <script>
        const questions = [
            {
                id: 'position',
                text: 'What\'s your primary sleeping position?',
                auto: true,
                options: [
                    { val: 'side', text: '🤱 Side Sleeper', desc: 'Sleep on my side most nights' },
                    { val: 'back', text: '😴 Back Sleeper', desc: 'Sleep on my back facing up' },
                    { val: 'stomach', text: '🛌 Stomach Sleeper', desc: 'Sleep face down' },
                    { val: 'mixed', text: '🔄 Combination', desc: 'Change positions during night' }
                ]
            },
            {
                id: 'firmness',
                text: 'What firmness do you prefer?',
                auto: true,
                options: [
                    { val: 'soft', text: '☁️ Soft', desc: 'Like sleeping on a cloud' },
                    { val: 'medium', text: '⚖️ Medium', desc: 'Balanced support and comfort' },
                    { val: 'firm', text: '💪 Firm', desc: 'Strong support, minimal sink' }
                ]
            },
            {
                id: 'issues',
                text: 'Any sleep issues? (Select all that apply)',
                multi: true,
                options: [
                    { val: 'neck', text: '😣 Neck Pain', desc: 'Regular neck discomfort' },
                    { val: 'snoring', text: '😪 Snoring', desc: 'Breathing issues at night' },
                    { val: 'hot', text: '🥵 Sleep Hot', desc: 'Often feel too warm' },
                    { val: 'none', text: '✨ None', desc: 'No specific issues' }
                ]
            },
            {
                id: 'budget',
                text: 'What\'s your budget?',
                auto: true,
                options: [
                    { val: 'low', text: '💵 Under $50', desc: 'Best value options' },
                    { val: 'mid', text: '💰 $50-$100', desc: 'Quality balance' },
                    { val: 'high', text: '💎 $100+', desc: 'Premium options' }
                ]
            }
        ];
        
        const measurementSteps = [
            { name: 'face', title: 'Position Your Face', instruction: 'Align face in guide, then capture' },
            { name: 'neck', title: 'Step 1: Neck Width', instruction: 'Place points at each side of your neck' },
            { name: 'shoulders', title: 'Step 2: Shoulder Width', instruction: 'Place points at each shoulder' },
            { name: 'length', title: 'Step 3: Neck Length', instruction: 'Place points from neck base to shoulder' }
        ];
        
        let currentQ = 0;
        let answers = {};
        let measurements = null;
        let cameraStream = null;
        let currentMeasurementStep = 0;
        let currentPoints = [];
        let measurementElements = [];
        let isFaceAligned = false;
        let isImageCaptured = false;
        let distanceInterval = null;
        let cameraMeasurements = { neck: null, shoulders: null, length: null };
        
        function init() {
            document.getElementById('progress').style.width = '25%';
        }
        
        function startCamera() {
            document.getElementById('camera').classList.add('active');
            currentMeasurementStep = 0;
            updateMeasurementStep();
            
            // Show face guide initially
            document.querySelector('.face-guide').style.display = 'block';
            document.querySelector('.distance-indicator').style.display = 'block';
            
            navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: 'user', width: { ideal: 1280 }, height: { ideal: 720 } }
            }).then(stream => {
                cameraStream = stream;
                document.getElementById('camera-feed').srcObject = stream;
                
                setTimeout(() => startDistanceDetection(), 1000);
            }).catch(err => {
                alert('Camera access required for measurements');
                closeCamera();
            });
        }
        
        function startDistanceDetection() {
            let distance = 70;
            const target = 50;
            let adjusting = true;
            
            distanceInterval = setInterval(() => {
                if (!document.getElementById('camera').classList.contains('active')) {
                    clearInterval(distanceInterval);
                    return;
                }
                
                if (adjusting) {
                    const diff = target - distance;
                    distance += diff * 0.1 + (Math.random() - 0.5) * 2;
                    if (Math.abs(distance - target) < 1) adjusting = false;
                } else {
                    distance = target + (Math.random() - 0.5) * 5;
                }
                
                updateDistanceIndicator(distance, target);
            }, 200);
        }
        
        function updateDistanceIndicator(current, perfect) {
            const circle = document.getElementById('distance-circle');
            const feedback = document.getElementById('distance-feedback');
            const outline = document.getElementById('face-outline');
            const tolerance = 10;
            
            circle.classList.remove('too-close', 'too-far', 'perfect');
            feedback.classList.remove('too-close', 'too-far', 'perfect');
            outline.classList.remove('aligned');
            
            if (current < perfect - tolerance) {
                circle.classList.add('too-close');
                feedback.classList.add('show', 'too-close');
                feedback.textContent = '📏 Move back slowly';
            } else if (current > perfect + tolerance) {
                circle.classList.add('too-far');
                feedback.classList.add('show', 'too-far');
                feedback.textContent = '📏 Move closer slowly';
            } else {
                circle.classList.add('perfect');
                feedback.classList.add('show', 'perfect');
                feedback.textContent = '✅ Perfect! Click capture';
                outline.classList.add('aligned');
                
                if (!isFaceAligned) {
                    isFaceAligned = true;
                    document.getElementById('capture-btn').style.display = 'block';
                }
            }
        }
        
        function captureImage() {
            const video = document.getElementById('camera-feed');
            const canvas = document.getElementById('captured-image');
            const ctx = canvas.getContext('2d');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            ctx.scale(-1, 1);
            ctx.drawImage(video, -canvas.width, 0, canvas.width, canvas.height);
            
            video.style.display = 'none';
            canvas.style.display = 'block';
            canvas.style.width = '100%';
            canvas.style.height = '100%';
            canvas.style.objectFit = 'contain';
            canvas.style.transform = 'scaleX(-1) scale(0.8)';
            
            isImageCaptured = true;
            
            // Hide face guides
            document.querySelector('.face-guide').style.display = 'none';
            document.querySelector('.distance-indicator').style.display = 'none';
            document.getElementById('distance-feedback').classList.remove('show');
            
            if (distanceInterval) {
                clearInterval(distanceInterval);
                distanceInterval = null;
            }
            
            // Update UI
            document.getElementById('capture-btn').style.display = 'none';
            document.getElementById('retake-btn').style.display = 'block';
            
            // Start measurements
            currentMeasurementStep = 1;
            updateMeasurementStep();
            document.getElementById('add-point-btn').style.display = 'block';
        }
        
        function retakePhoto() {
            const video = document.getElementById('camera-feed');
            const canvas = document.getElementById('captured-image');
            
            video.style.display = 'block';
            canvas.style.display = 'none';
            
            isImageCaptured = false;
            isFaceAligned = false;
            
            document.querySelector('.face-guide').style.display = 'block';
            document.querySelector('.distance-indicator').style.display = 'block';
            
            document.getElementById('capture-btn').style.display = 'none';
            document.getElementById('retake-btn').style.display = 'none';
            document.getElementById('add-point-btn').style.display = 'none';
            
            clearPoints();
            currentMeasurementStep = 0;
            updateMeasurementStep();
            startDistanceDetection();
        }
        
        function updateMeasurementStep() {
            const step = measurementSteps[currentMeasurementStep];
            document.getElementById('measurement-step').textContent = step.title;
            document.getElementById('measurement-instruction').textContent = step.instruction;
        }
        
        function addPoint() {
            if (currentPoints.length < 2) {
                const centerX = window.innerWidth / 2;
                const centerY = window.innerHeight / 2;
                const pointId = Date.now();
                
                const pointData = { x: centerX, y: centerY, id: pointId };
                currentPoints.push(pointData);
                
                createDraggablePoint(centerX, centerY, pointId);
                
                if (currentPoints.length === 2) {
                    createMeasurementLine();
                    document.getElementById('add-point-btn').style.display = 'none';
                    document.getElementById('next-step-btn').style.display = 'block';
                }
            }
        }
        
        function createDraggablePoint(x, y, id) {
            const point = document.createElement('div');
            point.className = 'measurement-point';
            point.dataset.pointId = id;
            point.style.left = x + 'px';
            point.style.top = y + 'px';
            point.innerHTML = '<div class="point-inner"></div>';
            
            let isDragging = false;
            
            const handleStart = (e) => {
                isDragging = true;
                point.classList.add('active');
                e.preventDefault();
            };
            
            const handleMove = (e) => {
                if (!isDragging) return;
                
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                
                point.style.left = clientX + 'px';
                point.style.top = clientY + 'px';
                
                const pointData = currentPoints.find(p => p.id === id);
                if (pointData) {
                    pointData.x = clientX;
                    pointData.y = clientY;
                    updateMeasurementLine();
                }
                
                e.preventDefault();
            };
            
            const handleEnd = () => {
                isDragging = false;
                point.classList.remove('active');
            };
            
            point.addEventListener('touchstart', handleStart, { passive: false });
            document.addEventListener('touchmove', handleMove, { passive: false });
            document.addEventListener('touchend', handleEnd);
            
            point.addEventListener('mousedown', handleStart);
            document.addEventListener('mousemove', handleMove);
            document.addEventListener('mouseup', handleEnd);
            
            document.getElementById('measurement-visuals').appendChild(point);
            measurementElements.push(point);
        }
        
        function createMeasurementLine() {
            const line = document.createElement('div');
            line.className = 'measurement-line';
            line.id = 'current-line';
            
            const label = document.createElement('div');
            label.className = 'measurement-label';
            label.id = 'current-label';
            
            document.getElementById('measurement-visuals').appendChild(line);
            document.getElementById('measurement-visuals').appendChild(label);
            measurementElements.push(line, label);
            
            updateMeasurementLine();
        }
        
        function updateMeasurementLine() {
            if (currentPoints.length !== 2) return;
            
            const line = document.getElementById('current-line');
            const label = document.getElementById('current-label');
            if (!line || !label) return;
            
            const p1 = currentPoints[0];
            const p2 = currentPoints[1];
            
            const dx = p2.x - p1.x;
            const dy = p2.y - p1.y;
            const distance = Math.sqrt(dx * dx + dy * dy);
            const angle = Math.atan2(dy, dx) * 180 / Math.PI;
            
            line.style.left = p1.x + 'px';
            line.style.top = p1.y + 'px';
            line.style.width = distance + 'px';
            line.style.transform = `rotate(${angle}deg)`;
            
            // Convert pixels to cm (calibration factor)
            const calibrationFactor = 6;
            const cm = (distance / calibrationFactor).toFixed(1);
            label.textContent = cm + ' cm';
            label.style.left = (p1.x + p2.x) / 2 + 'px';
            label.style.top = (p1.y + p2.y) / 2 + 'px';
            
            // Save measurement
            const steps = ['face', 'neck', 'shoulders', 'length'];
            if (currentMeasurementStep > 0) {
                cameraMeasurements[steps[currentMeasurementStep]] = parseFloat(cm);
            }
        }
        
        function clearPoints() {
            currentPoints = [];
            measurementElements.forEach(el => {
                if (el && el.parentNode) {
                    el.parentNode.removeChild(el);
                }
            });
            measurementElements = [];
            document.getElementById('add-point-btn').style.display = 'block';
            document.getElementById('next-step-btn').style.display = 'none';
        }
        
        function nextStep() {
            currentMeasurementStep++;
            currentPoints = [];
            measurementElements.forEach(el => {
                if (el && el.parentNode) {
                    el.parentNode.removeChild(el);
                }
            });
            measurementElements = [];
            
            if (currentMeasurementStep < measurementSteps.length) {
                updateMeasurementStep();
                document.getElementById('add-point-btn').style.display = 'block';
                document.getElementById('next-step-btn').style.display = 'none';
            } else {
                // Measurements complete
                measurements = {
                    neck: cameraMeasurements.neck,
                    shoulders: cameraMeasurements.shoulders,
                    length: cameraMeasurements.length,
                    timestamp: new Date().toISOString()
                };
                
                closeCamera();
                displayMeasurements();
            }
        }
        
        function closeCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            
            if (distanceInterval) {
                clearInterval(distanceInterval);
                distanceInterval = null;
            }
            
            document.getElementById('camera').classList.remove('active');
            
            // Reset camera state
            currentMeasurementStep = 0;
            currentPoints = [];
            isFaceAligned = false;
            isImageCaptured = false;
            clearPoints();
            
            // Reset UI
            document.getElementById('camera-feed').style.display = 'block';
            document.getElementById('captured-image').style.display = 'none';
            document.querySelector('.face-guide').style.display = 'block';
            document.querySelector('.distance-indicator').style.display = 'block';
            document.getElementById('distance-feedback').classList.remove('show');
            
            // Reset buttons
            document.getElementById('capture-btn').style.display = 'none';
            document.getElementById('retake-btn').style.display = 'none';
            document.getElementById('add-point-btn').style.display = 'none';
            document.getElementById('next-step-btn').style.display = 'none';
        }
        
        function displayMeasurements() {
            if (measurements) {
                document.getElementById('neck-display').textContent = measurements.neck;
                document.getElementById('shoulder-display').textContent = measurements.shoulders;
                document.getElementById('length-display').textContent = measurements.length;
                
                document.getElementById('camera-prompt').style.display = 'none';
                document.getElementById('current-measurements').style.display = 'block';
                
                document.getElementById('progress').style.width = '50%';
            }
        }
        
        function continueToQuiz() {
            document.getElementById('measurements').style.display = 'none';
            document.getElementById('quiz').style.display = 'block';
            document.getElementById('nav').style.display = 'flex';
            currentQ = 0;
            showQuestion(0);
        }
        
        function showQuestion(i) {
            const quiz = document.getElementById('quiz');
            const prog = document.getElementById('progress');
            const prev = document.getElementById('prev');
            const next = document.getElementById('next');
            
            quiz.innerHTML = '';
            
            if (i < questions.length) {
                const q = questions[i];
                let html = `<h2>${q.text}</h2>`;
                
                q.options.forEach(opt => {
                    const selected = q.multi ? 
                        (answers[q.id] && answers[q.id].includes(opt.val)) :
                        (answers[q.id] === opt.val);
                    
                    html += `
                        <div class="option ${selected ? 'selected' : ''}" onclick="select('${q.id}', '${opt.val}')">
                            <strong>${opt.text}</strong>
                            <small>${opt.desc}</small>
                        </div>
                    `;
                });
                
                if (q.multi) {
                    html += '<p style="text-align: center; opacity: 0.7; margin-top: 15px;">💡 Select multiple options</p>';
                }
                
                quiz.innerHTML = html;
                
                prog.style.width = (50 + ((i + 1) / questions.length) * 50) + '%';
                prev.style.display = i > 0 ? 'block' : 'none';
                next.textContent = i === questions.length - 1 ? 'Get Results' : 'Next';
                
                const hasAnswer = q.multi ? 
                    (answers[q.id] && answers[q.id].length > 0) :
                    !!answers[q.id];
                
                next.disabled = !hasAnswer;
            }
        }
        
        function select(qId, val) {
            const q = questions[currentQ];
            
            if (q.multi) {
                if (!answers[qId]) answers[qId] = [];
                
                if (val === 'none') {
                    answers[qId] = ['none'];
                } else {
                    answers[qId] = answers[qId].filter(v => v !== 'none');
                    const idx = answers[qId].indexOf(val);
                    if (idx > -1) {
                        answers[qId].splice(idx, 1);
                    } else {
                        answers[qId].push(val);
                    }
                }
                showQuestion(currentQ);
            } else {
                answers[qId] = val;
                showQuestion(currentQ);
                
                if (q.auto) {
                    setTimeout(() => nextQ(), 500);
                }
            }
        }
        
        function nextQ() {
            if (currentQ < questions.length - 1) {
                currentQ++;
                showQuestion(currentQ);
            } else {
                showResults();
            }
        }
        
        function prevQ() {
            if (currentQ > 0) {
                currentQ--;
                showQuestion(currentQ);
            }
        }
        
        function showResults() {
            document.getElementById('quiz').style.display = 'none';
            document.getElementById('nav').style.display = 'none';
            document.getElementById('progress').style.width = '100%';
            
            const results = document.getElementById('results');
            results.style.display = 'block';
            results.innerHTML = `
                <div style="text-align: center; padding: 50px;">
                    <div style="width: 50px; height: 50px; border: 3px solid rgba(255,255,255,0.3); border-top: 3px solid #a855f7; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
                    <h3>Analyzing your measurements...</h3>
                    <p style="opacity: 0.8;">Creating your perfect pillow recommendations</p>
                </div>
            `;
            
            setTimeout(() => {
                const recs = generateRecommendations();
                displayResults(recs);
            }, 2500);
        }
        
        function generateRecommendations() {
            const pos = answers.position;
            const budget = answers.budget;
            
            let sizeRec = 'Standard Size';
            let loftRec = 'Medium Loft (4-6")';
            
            if (measurements) {
                if (measurements.neck > 15) {
                    loftRec = 'High Loft (6-7")';
                } else if (measurements.neck < 12) {
                    loftRec = 'Low Loft (3-4")';
                }
                
                if (measurements.shoulders > 50) {
                    sizeRec = 'King Size (20" x 36")';
                } else if (measurements.shoulders < 35) {
                    sizeRec = 'Standard Size (20" x 26")';
                } else {
                    sizeRec = 'Queen Size (20" x 30")';
                }
            }
            
            const pillows = {
                side: { name: '🌙 Contour Side Sleeper Pillow', score: 95 },
                back: { name: '☁️ Cervical Support Pillow', score: 93 },
                stomach: { name: '🪶 Ultra-Slim Comfort Pillow', score: 91 },
                mixed: { name: '🔄 Adjustable Universal Pillow', score: 94 }
            };
            
            const primary = pillows[pos] || pillows.mixed;
            
            const recs = [
                {
                    ...primary,
                    type: 'Primary Recommendation',
                    desc: `Ergonomically designed for ${pos} sleepers. Your measurements indicate ${loftRec} in ${sizeRec}.`,
                    features: ['Contoured Design', 'Premium Materials', 'Breathable Cover', '5-Year Warranty'],
                    price: budget === 'low' ? '$25-49' : budget === 'mid' ? '$50-99' : '$100-199',
                    brands: budget === 'low' ? ['Utopia Bedding', 'Beckham Hotel'] : 
                            budget === 'mid' ? ['Purple', 'Casper', 'Coop Home Goods'] : 
                            ['Tempur-Pedic', 'Saatva', 'Brooklinen']
                }
            ];
            
            if (answers.issues && answers.issues.includes('neck')) {
                recs.push({
                    name: '💆 Orthopedic Relief Pillow',
                    type: 'Therapeutic Option',
                    desc: 'Doctor-designed for neck pain relief with your exact measurements.',
                    features: ['Ergonomic Shape', 'Firm Support', 'Pain Relief', 'Medical Grade'],
                    score: 92,
                    price: '$75-150',
                    brands: ['Tempur-Pedic', 'Cervical Pillow Co.']
                });
            }
            
            if (answers.issues && answers.issues.includes('hot')) {
                recs.push({
                    name: '❄️ Cooling Gel Pillow',
                    type: 'Temperature Solution',
                    desc: 'Advanced cooling technology sized for your measurements.',
                    features: ['Gel-Infused', 'Breathable Mesh', 'Cool-to-Touch', 'Phase Change'],
                    score: 89,
                    price: '$60-120',
                    brands: ['Purple', 'GhostBed', 'Sleep Number']
                });
            }
            
            return recs;
        }
        
        function displayResults(recs) {
            let html = `
                <div style="text-align: center; margin-bottom: 50px;">
                    <h2 style="background: linear-gradient(45deg, #fff, #a855f7, #06b6d4); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-size: 36px; margin-bottom: 15px; line-height: 1.2;">
                        Your Perfect Pillow Matches
                    </h2>
                    <p style="opacity: 0.8; font-size: 18px; line-height: 1.5;">Based on your precise measurements and sleep profile</p>
                </div>
            `;
            
            // Show measurements summary
            html += `
                <div class="result-card" style="border: 2px solid #a855f7; background: rgba(168,85,247,0.1); margin-bottom: 35px;">
                    <h3 style="display: flex; align-items: center; gap: 15px; margin-bottom: 25px; font-size: 22px;">
                        <span style="font-size: 28px;">📏</span>
                        Your Custom Measurements
                    </h3>
                    <div class="measurement-grid">
                        <div class="measurement-card" style="background: rgba(168,85,247,0.2); padding: 25px 20px;">
                            <div class="measurement-value" style="font-size: 32px;">${measurements.neck}</div>
                            <div class="measurement-label" style="font-size: 13px;">Neck Width (cm)</div>
                        </div>
                        <div class="measurement-card" style="background: rgba(6,182,212,0.2); padding: 25px 20px;">
                            <div class="measurement-value" style="color: #06b6d4; font-size: 32px;">${measurements.shoulders}</div>
                            <div class="measurement-label" style="font-size: 13px;">Shoulder Width (cm)</div>
                        </div>
                        <div class="measurement-card" style="background: rgba(236,72,153,0.2); padding: 25px 20px;">
                            <div class="measurement-value" style="color: #ec4899; font-size: 32px;">${measurements.length}</div>
                            <div class="measurement-label" style="font-size: 13px;">Neck-Shoulder (cm)</div>
                        </div>
                    </div>
                </div>
            `;
            
            recs.forEach((rec, i) => {
                html += `
                    <div class="result-card" ${i === 0 ? 'style="border: 2px solid #a855f7; position: relative; margin-bottom: 35px;"' : 'style="margin-bottom: 30px;"'}>
                        ${i === 0 ? '<div style="position: absolute; top: -15px; right: 25px; background: linear-gradient(45deg, #a855f7, #06b6d4); padding: 8px 18px; border-radius: 20px; font-size: 12px; font-weight: bold;">⭐ TOP CHOICE</div>' : ''}
                        
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 25px; flex-wrap: wrap; gap: 20px;">
                            <div style="flex: 1;">
                                <h3 style="font-size: 24px; margin-bottom: 12px; line-height: 1.3;">${rec.name}</h3>
                                <span style="background: rgba(255,255,255,0.1); padding: 8px 18px; border-radius: 15px; font-size: 12px; border: 1px solid rgba(255,255,255,0.2);">${rec.type}</span>
                            </div>
                            <div style="text-align: center; min-width: 80px;">
                                <div style="font-size: 36px; font-weight: bold; background: linear-gradient(45deg, #a855f7, #06b6d4); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">${rec.score}%</div>
                                <div style="font-size: 11px; opacity: 0.7;">Match Score</div>
                            </div>
                        </div>
                        
                        <p style="margin-bottom: 25px; opacity: 0.9; font-size: 16px; line-height: 1.6;">${rec.desc}</p>
                        
                        <div style="margin-bottom: 25px;">
                            <h4 style="margin-bottom: 15px; font-size: 16px;">Key Features:</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                                ${rec.features.map(f => `<span style="background: rgba(168,85,247,0.2); padding: 8px 14px; border-radius: 12px; font-size: 13px; border: 1px solid rgba(168,85,247,0.3);">${f}</span>`).join('')}
                            </div>
                        </div>
                        
                        <div style="background: rgba(255,255,255,0.05); padding: 25px; border-radius: 15px; border: 1px solid rgba(255,255,255,0.1);">
                            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px;">
                                <div style="flex: 1;">
                                    <h4 style="margin-bottom: 12px; font-size: 16px;">Recommended Brands:</h4>
                                    <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                                        ${rec.brands.map(brand => `<span style="background: rgba(255,255,255,0.1); padding: 8px 14px; border-radius: 12px; font-size: 13px;">${brand}</span>`).join('')}
                                    </div>
                                </div>
                                <div style="text-align: right; min-width: 120px;">
                                    <div style="font-size: 12px; opacity: 0.7; margin-bottom: 6px;">Price Range</div>
                                    <div style="color: #10b981; font-size: 24px; font-weight: bold;">${rec.price}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += `
                <div style="text-align: center; margin-top: 50px; padding: 35px 30px; background: rgba(16,185,129,0.1); border: 2px solid rgba(16,185,129,0.3); border-radius: 20px;">
                    <h3 style="margin-bottom: 20px; font-size: 24px;">🎉 Your Perfect Sleep Awaits!</h3>
                    <p style="opacity: 0.9; margin-bottom: 30px; line-height: 1.6;">Recommendations based on your precise camera measurements</p>
                    
                    <div class="share-save-buttons">
                        <button class="btn btn-primary" onclick="saveResults()" style="font-size: 16px;">
                            💾 Save Results
                        </button>
                        <button class="btn btn-secondary" onclick="shareResults()" style="font-size: 16px;">
                            📤 Share Results
                        </button>
                    </div>
                    
                    <button class="btn btn-secondary" onclick="location.reload()" style="font-size: 16px; margin-top: 20px;">
                        🔄 Start New Assessment
                    </button>
                </div>
            `;
            
            document.getElementById('results').innerHTML = html;
        }
        
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
